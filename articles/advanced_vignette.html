<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Advanced Features • ecmwfr</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="/apple-touch-icon.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.1/css/all.min.css" integrity="sha256-PbSmjxuVAzJ6FPvNYsrXygfGhNJYyZ2GktDbkMBqQZg=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.1/css/v4-shims.min.css" integrity="sha256-A6jcAdwFD48VMjlI3GDxUd+eCQa7/KWy6G9oe/ovaPA=" crossorigin="anonymous">
<!-- Fonts --><link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Titillium+Web:ital,wght@0,300;0,400;0,700;1,300;1,400&amp;display=swap" rel="stylesheet">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" integrity="sha256-FiZwavyI2V6+EXO1U+xzLG3IKldpiTFf3153ea9zikQ=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.9.4/headroom.min.js" integrity="sha256-DJFC1kqIhelURkuza0AvYal5RxMtpzLjFhsnVIeuk+U=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.9.4/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><!-- ropensci --><link href="../bglabs.css" rel="stylesheet">
<meta property="og:title" content="Advanced Features">
</head>
<body data-spy="scroll" data-target="#toc">


    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">

    <div class="navbar-header">

      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>

      <div class="navbar-brand-container">
        <a class="external-link hidden-sm hidden-xs" href="https://bluegreenlabs.org">
          <img src="https://bluegreenlabs.org/img/logo_text_small.png" id="hexlogo" alt="bluegreen labs"></a>
        <a class="external-link hidden-md hidden-lg" href="https://bluegreenlabs.org">
          <img src="https://bluegreenlabs.org/img/logo.png" id="hexlogo" alt="bluegreen labs"></a>
        <a class="navbar-brand" href="../index.html">
           <i>ecmwfr <small>v2.0.3</small></i>
        </a>
      </div>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav navbar-right">
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles

    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/advanced_vignette.html">Advanced Features</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
        <li>
  <a href="https://github.com/bluegreen-labs/ecmwfr/" class="external-link">
    <span class="fab fa-github fa-lg"></span>

  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->



      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Advanced Features</h1>
                        <h4 data-toc-skip class="author">Koen
Hufkens</h4>
            
            <h4 data-toc-skip class="date">2025-02-10</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/bluegreen-labs/ecmwfr/blob/v2.0.3/vignettes/advanced_vignette.Rmd" class="external-link"><code>vignettes/advanced_vignette.Rmd</code></a></small>
      <div class="hidden name"><code>advanced_vignette.Rmd</code></div>

    </div>

    
    
<div class="section level2">
<h2 id="advanced-features">Advanced Features<a class="anchor" aria-label="anchor" href="#advanced-features"></a>
</h2>
<p>This is a brief overview of some of the more advanced options in the
<code>ecmwfr</code> package.</p>
<div class="section level3">
<h3 id="piped-requests">Piped requests<a class="anchor" aria-label="anchor" href="#piped-requests"></a>
</h3>
<p>Another hidden feature of <code>ecmwfr</code> is the fact that the
request is the first argument in the <code><a href="../reference/wf_request.html">wf_request()</a></code> function.
This means that any valid list can be piped into this function (using
the magrittr <code>%&gt;%</code> or native pipe symbol
<code>|&gt;</code>).</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>      product_type <span class="op">=</span> <span class="st">'reanalysis'</span>,</span>
<span>      variable <span class="op">=</span> <span class="st">'geopotential'</span>,</span>
<span>      year <span class="op">=</span> <span class="st">'2024'</span>,</span>
<span>      month <span class="op">=</span> <span class="st">'03'</span>,</span>
<span>      day <span class="op">=</span> <span class="st">'01'</span>,</span>
<span>      time <span class="op">=</span> <span class="st">'13:00'</span>,</span>
<span>      pressure_level <span class="op">=</span> <span class="st">'1000'</span>,</span>
<span>      data_format <span class="op">=</span> <span class="st">'grib'</span>,</span>
<span>      dataset_short_name <span class="op">=</span> <span class="st">'reanalysis-era5-pressure-levels'</span>,</span>
<span>      target <span class="op">=</span> <span class="st">'test.grib'</span></span>
<span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/wf_request.html">wf_request</a></span><span class="op">(</span>path <span class="op">=</span> <span class="st">"~"</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="dynamic-request-functions-archetypes">Dynamic request functions / archetypes<a class="anchor" aria-label="anchor" href="#dynamic-request-functions-archetypes"></a>
</h3>
<p>Once a valid request has been created it can be made into a dynamic
function using <code>achetypes</code>. Archetype functions are build
using a valid <code>ecmwfr</code> ECMWF or CDS request and the vector
naming the field which are to be set as dynamic.</p>
<p>The <code><a href="../reference/wf_archetype.html">wf_archetype()</a></code> function creates a new function with
as parameters the dynamic fields previously assigned. The below example
show how to use the function to generate the custom
<code>dynamic_request()</code> function. We then use this new function
to alter the <code>day</code> and <code>target</code> fields and pipe
(<code>|&gt;</code>) into the <code><a href="../reference/wf_request.html">wf_request()</a></code> function to
retrieve the data.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># this is an example of a request</span></span>
<span><span class="va">dynamic_request</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/wf_archetype.html">wf_archetype</a></span><span class="op">(</span></span>
<span>  request <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>      product_type <span class="op">=</span> <span class="st">'reanalysis'</span>,</span>
<span>      variable <span class="op">=</span> <span class="st">'geopotential'</span>,</span>
<span>      year <span class="op">=</span> <span class="st">'2024'</span>,</span>
<span>      month <span class="op">=</span> <span class="st">'03'</span>,</span>
<span>      day <span class="op">=</span> <span class="st">'01'</span>,</span>
<span>      time <span class="op">=</span> <span class="st">'13:00'</span>,</span>
<span>      pressure_level <span class="op">=</span> <span class="st">'1000'</span>,</span>
<span>      data_format <span class="op">=</span> <span class="st">'grib'</span>,</span>
<span>      dataset_short_name <span class="op">=</span> <span class="st">'reanalysis-era5-pressure-levels'</span>,</span>
<span>      target <span class="op">=</span> <span class="st">'test.grib'</span></span>
<span>  <span class="op">)</span>,</span>
<span>  dynamic_fields <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"day"</span>, <span class="st">"target"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># change the day of the month</span></span>
<span><span class="fu">dynamic_request</span><span class="op">(</span>day <span class="op">=</span> <span class="st">"01"</span>, target <span class="op">=</span> <span class="st">"new.grib"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/wf_request.html">wf_request</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="batch-parallel-requests">Batch (parallel) requests<a class="anchor" aria-label="anchor" href="#batch-parallel-requests"></a>
</h3>
<p>As of version <code>1.4.0</code> you can submit parallel batch
requests. Using the archetypes, as discussed above, it was easy to
request multiple data products. However, these requests would go through
sequentially. The ECMWF CDS infrastructure allows up to 20 parallel
requests in your queue. The speed of downloading data could be increased
when submitting jobs in parallel rather than sequentially. A new
function <code><a href="../reference/wf_request.html">wf_request_batch()</a></code> now implements parallel CDS
requests, using lists of requests (potentially generated by an archetype
as per above).</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># creating a list of requests using wf_archetype()</span></span>
<span><span class="co"># setting the day value</span></span>
<span><span class="va">batch_request</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  <span class="fu">dynamic_request</span><span class="op">(</span>day <span class="op">=</span> <span class="st">"01"</span><span class="op">)</span>,</span>
<span>  <span class="fu">dynamic_request</span><span class="op">(</span>day <span class="op">=</span> <span class="st">"02"</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># submit a batch job using 2 workers</span></span>
<span><span class="co"># one for each in the list (the number of workers</span></span>
<span><span class="co"># can't exceed 20)</span></span>
<span><span class="fu"><a href="../reference/wf_request.html">wf_request_batch</a></span><span class="op">(</span></span>
<span>  <span class="va">batch_request</span>,</span>
<span>  workers <span class="op">=</span> <span class="fl">2</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
<div class="section level4">
<h4 id="mixing-data-services-in-batch-requests">Mixing data services in batch requests<a class="anchor" aria-label="anchor" href="#mixing-data-services-in-batch-requests"></a>
</h4>
<p>It is allowed to mix data services in a batch requests. This allows
you to formulate complex multi-service requests. Below you see a simple
example using a batch requests for data from both the CDS and ADS
services in one pass.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># CDS</span></span>
<span><span class="va">cds_request</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>      product_type <span class="op">=</span> <span class="st">'reanalysis'</span>,</span>
<span>      variable <span class="op">=</span> <span class="st">'geopotential'</span>,</span>
<span>      year <span class="op">=</span> <span class="st">'2024'</span>,</span>
<span>      month <span class="op">=</span> <span class="st">'03'</span>,</span>
<span>      day <span class="op">=</span> <span class="st">'01'</span>,</span>
<span>      time <span class="op">=</span> <span class="st">'13:00'</span>,</span>
<span>      pressure_level <span class="op">=</span> <span class="st">'1000'</span>,</span>
<span>      data_format <span class="op">=</span> <span class="st">'grib'</span>,</span>
<span>      dataset_short_name <span class="op">=</span> <span class="st">'reanalysis-era5-pressure-levels'</span>,</span>
<span>      target <span class="op">=</span> <span class="st">'test.grib'</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># ADS</span></span>
<span><span class="va">ads_request</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  dataset_short_name <span class="op">=</span> <span class="st">"cams-global-radiative-forcings"</span>,</span>
<span>  variable <span class="op">=</span> <span class="st">"radiative_forcing_of_carbon_dioxide"</span>,</span>
<span>  forcing_type <span class="op">=</span> <span class="st">"instantaneous"</span>,</span>
<span>  band <span class="op">=</span> <span class="st">"long_wave"</span>,</span>
<span>  sky_type <span class="op">=</span> <span class="st">"all_sky"</span>,</span>
<span>  level <span class="op">=</span> <span class="st">"surface"</span>,</span>
<span>  version <span class="op">=</span> <span class="st">"2"</span>,</span>
<span>  year <span class="op">=</span> <span class="st">"2018"</span>,</span>
<span>  month <span class="op">=</span> <span class="st">"06"</span>,</span>
<span>  target <span class="op">=</span> <span class="st">"download.grib"</span></span>
<span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="va">combined_request</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>  <span class="va">cds_request</span>,</span>
<span>  <span class="va">ads_request</span></span>
<span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="va">files</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/wf_request.html">wf_request_batch</a></span><span class="op">(</span></span>
<span>  <span class="va">combined_request</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
</div>
</div>
<div class="section level3">
<h3 id="date-specification">Date specification<a class="anchor" aria-label="anchor" href="#date-specification"></a>
</h3>
<p>For those familiar to ECMWF <em>mars</em> syntax: CDS/ADS does not
accept <code>date = "2000-01-01/to/2000-12-31"</code> specifications at
the moment. It is possible to specify one specific date via
<code>date = "2000-01-01"</code> or multiple days via
<code>date = ["2000-01-01","2000-01-02","2000-10-20"]</code> or
<code>date = "YYYY-MM-DD/YYYY-MM-DD"</code> but not via
<code>".../to/..."</code>.</p>
</div>
<div class="section level3">
<h3 id="environmental-variables-for-api-token">Environmental variables for API token<a class="anchor" aria-label="anchor" href="#environmental-variables-for-api-token"></a>
</h3>
<p>Alternatively to using <code><a href="../reference/wf_set_key.html">wf_set_key()</a></code>, you can set an
environmental variable containing your API.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.setenv.html" class="external-link">Sys.setenv</a></span><span class="op">(</span>ecmwfr_PAT<span class="op">=</span><span class="st">"abcd1234-foo-bar-98765431-XXXXXXXXXX"</span><span class="op">)</span></span></code></pre></div>
<p>This will need to be set at the beginning of each setting or added to
the user <code>.Renviron</code> file. Overall, this is considered
insecure, but might be the only option on some legacy or HPC systems to
get full <code>ecmwfr</code> functionality. A good blog post on why you
should not do this is provided by <a href="https://blog.r-hub.io/2024/02/28/key-advantages-of-using-keyring/" class="external-link">Maëlle
Salmon</a>.</p>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

      </div>

</div>



      <footer><!-- begin footer --><div class="footer">
    <div class="container">
        <div class="row start bottom-8">
            <div class="col-xs-10">
                <div class="row">
                    <div class="col-md-4 col-xs-6">
                        <a href="http://github.com/bluegreen-labs" target="_blank" class="external-link">
                          <div class="icon fab fa-github"></div></a>
                        <a href="https://bluegreenlabs.org/labs/" target="_blank" class="external-link">
                          <div class="icon fa fa-flask"></div></a>
                        <a href="http://twitter.com/bluegreen_labs" target="_blank" class="external-link">
                          <div class="icon fab fa-twitter"></div></a>
                    </div>
                </div>
                <div class="row top-4">
                    <div class="col-md-2 col-sm-4">
                        <ul>
<h5 class="bottom-2">About</h5>
                            <li><a href="https://bluegreenlabs.org/#intro" class="external-link">BlueGreen Labs</a></li>
                            <li><a href="https://bluegreenlabs.org/#people" class="external-link">Our Team</a></li>
                            <li><a href="https://bluegreenlabs.org/#contact" class="external-link">Contact Us</a></li>
                        </ul>
</div>
                    <div class="col-md-2 col-sm-4">
                        <ul>
<h5 class="bottom-2">Resources</h5>
                            <li><a href="https://github.com/bluegreen-labs" class="external-link">Packages</a></li>
                            <li><a href="https://bluegreenlabs.org/publication/" class="external-link">Publications</a></li>
                            <li><a href="https://bluegreenlabs.org/post/" class="external-link">Blog</a></li>
                        </ul>
</div>

                </div>
            </div>
        </div>
    </div>
</div>
<!-- / end footer -->

      </footer>
</div>






  </body>
</html>
